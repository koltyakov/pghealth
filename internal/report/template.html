<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>PostgreSQL Health Check Report</title>
  <style>
    /* Base styles */
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 24px;
      color: #111827;
    }

    /* Header */
    header {
      margin-bottom: 36px;
    }

    h1 {
      font-size: 20px;
      margin: 0 0 12px 0;
    }

    header>div {
      margin-top: 6px;
    }

    h2 {
      margin-top: 24px;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 4px;
    }

    h3 {
      margin-top: 20px;
    }

    /* Cards and grid layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }

    .card {
      border: 1px solid #e5e7eb;
      padding: 12px;
      background: #fff;
    }

    .card>strong {
      display: block;
      margin-bottom: 8px;
    }

    .card>div {
      margin: 6px 0;
    }

    .card small {
      display: block;
      margin-top: 6px;
    }

    .warn {
      border-left: 4px solid #f59e0b;
    }

    .rec {
      border-left: 4px solid #10b981;
    }

    .info {
      border-left: 4px solid #3b82f6;
    }

    /* Tables */
    .table-wrap {
      margin: 8px 0;
      overflow: hidden;
    }

    table {
      border-collapse: collapse;
      border-spacing: 0;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #9ca3af;
      padding: 10px 12px;
      text-align: left;
      vertical-align: top;
    }

    thead th {
      background: #f3f4f6;
      font-weight: 600;
      border-bottom: 2px solid #9ca3af;
    }

    tbody tr:nth-child(even) {
      background: #fcfcfd;
    }

    tbody tr:hover {
      background: #f8fafc;
    }

    /* Table row limiting */
    .table-wrap.collapsed tbody tr:nth-child(n+11) {
      display: none;
    }

    /* Table controls */
    .table-tools {
      margin: 12px 0 0;
      display: flex;
      justify-content: flex-end;
      padding: 0;
    }

    .toggle-rows,
    .show-full,
    .show-plan {
      background: #fff;
      border: 1px solid #d1d5db;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
      color: #374151;
    }

    .toggle-rows:hover,
    .show-full:hover,
    .show-plan:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }

    /* Query display */
    pre {
      white-space: pre-wrap;
      max-height: 8em;
      overflow: auto;
      margin: 0;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      padding: 8px;
    }

    pre.query.expanded {
      max-height: none;
    }

    .query-short {
      display: block;
    }

    .query-full {
      display: none;
    }

    pre.query.expanded .query-short {
      display: none;
    }

    pre.query.expanded .query-full {
      display: block;
    }

    .show-full {
      margin-top: 6px;
    }

    /* Plan advice */
    .plan-advice {
      margin-top: 8px;
      padding: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 12px;
    }

    .plan-advice h4 {
      margin: 0 0 6px;
      font-size: 14px;
    }

    .plan-advice ul {
      margin: 6px 0 8px 18px;
    }

    .show-plan {
      margin-top: 6px;
    }

    .plan-pre {
      white-space: pre-wrap;
      max-height: 12em;
      overflow: auto;
      margin: 6px 0 0;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      padding: 8px;
    }

    .plan-pre.expanded {
      max-height: none;
    }

    /* Utility classes */
    .hot {
      background: #fff7ed;
    }

    .muted {
      color: #6b7280;
    }

    .nowrap {
      white-space: nowrap;
    }

    .section-note {
      margin: 8px 0 0;
      color: #4b5563;
    }

    .badge-attn {
      display: inline-block;
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
      padding: 2px 6px;
      font-size: 12px;
      border-radius: 4px;
    }

    code {
      background: #f3f4f6;
      padding: 2px 4px;
    }

    small {
      font-size: 12px;
      color: #4b5563;
    }
  </style>
</head>

<body>
  <header>
    <h1>PostgreSQL Health Check Report</h1>
    <div>{{if not (contains .Meta.Version "-dirty")}}Version: {{.Meta.Version}} &middot; {{end}}Started: {{fmtTime
      .Meta.StartedAt}} &middot; Duration: {{fmtDur .Meta.Duration}}</div>
    <div>Server: {{.Res.ConnInfo.Version}} &middot; DB: {{.Res.ConnInfo.CurrentDB}} &middot; User:
      {{.Res.ConnInfo.CurrentUser}} &middot; SSL: {{.Res.ConnInfo.SSL}}</div>
  </header>

  <section class="grid">
    {{range .A.Warnings}}
    <div class="card warn"><strong>{{.Title}}</strong>
      <div>{{.Description}}</div>
      <div><small>{{.Action}}</small></div>
    </div>
    {{end}}
    {{range .A.Recommendations}}
    <div class="card rec"><strong>{{.Title}}</strong>
      <div>{{.Description}}</div>
      <div><small>{{.Action}}</small></div>
    </div>
    {{end}}
    {{range .A.Infos}}
    <div class="card info"><strong>{{.Title}}</strong>
      <div>{{.Description}}</div>
      <div><small>{{.Action}}</small></div>
    </div>
    {{end}}
  </section>

  <!-- System & configuration -->
  <h2>Databases</h2>
  <div id="table-databases" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Size</th>
          <th>Tablespace</th>
          <th>Connections</th>
        </tr>
      </thead>
      <tbody>
        {{if .Res.DBs}}
        {{range .Res.DBs}}<tr>
          <td>{{.Name}}</td>
          <td>{{fmtBytes .SizeBytes}}</td>
          <td>{{.Tablespaces}}</td>
          <td>{{fmtInt .ConnCount}}</td>
        </tr>{{end}}
        {{else}}
        <tr>
          <td colspan="4" class="muted">No data</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  {{if gt (len .Res.DBs) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-databases">Show all</button></div>{{end}}
  </div>
  {{if .DBsSummary}}<p class="section-note">{{.DBsSummary}}</p>{{end}}

  <h2>Connections</h2>
  <div id="table-connections" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          <th>Database</th>
          <th>State</th>
          <th>Count</th>
        </tr>
      </thead>
      <tbody>
        {{if .Activity}}
        {{range .Activity}}<tr>
          <td>{{.Datname}}</td>
          <td>{{.State}}</td>
          <td>{{fmtInt .Count}}</td>
        </tr>{{end}}
        {{else}}
        <tr>
          <td colspan="3" class="muted">No data</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  {{if gt (len .Activity) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-connections">Show all</button></div>{{end}}
  </div>
  {{if .ConnSummary}}<p class="section-note">{{.ConnSummary}}</p>{{end}}

  <h3>Connections by client</h3>
  <div id="table-clients" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>{{if .ShowHostname}}<th>Hostname</th>{{end}}<th>Address</th>
          <th>User</th>
          <th>Application</th>
          <th>Connections</th>
        </tr>
      </thead>
      <tbody>
        {{if .Res.ConnectionsByClient}}
        {{range .Res.ConnectionsByClient}}<tr>{{if $.ShowHostname}}<td>{{.Hostname}}</td>{{end}}<td>{{.Address}}</td>
          <td>{{.User}}</td>
          <td>{{.Application}}</td>
          <td>{{fmtInt .Count}}</td>
        </tr>{{end}}
        {{else}}
        {{if .ShowHostname}}
        <tr>
          <td colspan="5" class="muted">No data</td>
        </tr>
        {{else}}
        <tr>
          <td colspan="4" class="muted">No data</td>
        </tr>
        {{end}}
        {{end}}
      </tbody>
    </table>
  {{if gt (len .Res.ConnectionsByClient) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-clients">Show all</button></div>{{end}}
  </div>
  {{if .ClientsSummary}}<p class="section-note">{{.ClientsSummary}}</p>{{end}}

  <h2>Settings (subset)</h2>
  <div id="table-settings" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Value</th>
          <th>Unit</th>
          <th>Source</th>
        </tr>
      </thead>
      <tbody>
        {{if .Res.Settings}}
        {{range .Res.Settings}}<tr>
          <td>{{.Name}}</td>
          <td>{{.Val}}</td>
          <td>{{.Unit}}</td>
          <td>{{.Source}}</td>
        </tr>{{end}}
        {{else}}
        <tr>
          <td colspan="4" class="muted">No data</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  {{if gt (len .Res.Settings) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-settings">Show all</button></div>{{end}}
  </div>

  {{if .Res.ExtensionStats}}
  <h2>Installed extensions</h2>
  <div id="table-extensions" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          {{/* Show Database column if entries come from multiple DBs */}}
          {{- $showDB := false -}}
          {{- if gt (len .Res.ExtensionStats) 0 -}}
          {{- $first := (index .Res.ExtensionStats 0).Database -}}
          {{- range .Res.ExtensionStats -}}
          {{- if ne .Database $first -}}{{- $showDB = true -}}{{- end -}}
          {{- end -}}
          {{- end -}}
          {{if $showDB}}<th>Database</th>{{end}}
          <th>Name</th>
          <th>Version</th>
          <th>Description</th>
          <th>Schema</th>
        </tr>
      </thead>
      <tbody>
        {{range .Res.ExtensionStats}}
        <tr>
          {{if $showDB}}<td>{{.Database}}</td>{{end}}
          <td>{{.Name}}</td>
          <td>{{.Version}}</td>
          <td>{{.Description}}</td>
          <td>{{.Schema}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}

  <!-- Resource & I/O -->
  <h2>Memory</h2>
  <div id="table-memory" class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Metric</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>Block size</td><td>{{fmtBytes .Res.MemoryStats.BlockSizeBytes}}</td></tr>
        <tr><td>shared_buffers (bytes)</td><td>{{fmtBytes .Res.MemoryStats.SharedBuffersBytes}}</td></tr>
        <tr><td>shared_buffers (buffers)</td><td>{{fmtI64 .Res.MemoryStats.SharedBuffersSetting}}</td></tr>
        {{if .Res.MemoryStats.BuffercacheAvailable}}
        <tr><td>Buffers in use</td><td>{{fmtI64 .Res.MemoryStats.BuffercacheUsedBuffers}} ({{fmtBytes .Res.MemoryStats.BuffercacheUsedBytes}})</td></tr>
        {{else}}
        <tr><td>Buffers in use</td><td class="muted">pg_buffercache not installed</td></tr>
        {{end}}
        <tr><td>Temp files (current DB)</td><td>{{fmtI64 .Res.MemoryStats.TempFilesCurrentDB}}</td></tr>
        <tr><td>Temp bytes (current DB)</td><td>{{fmtBytes .Res.MemoryStats.TempBytesCurrentDB}}</td></tr>
      </tbody>
    </table>
  </div>
  <p class="section-note">Note: Temp files and temp bytes are cumulative since statistics were last reset (often since
    server start) and do not represent the current on-disk temporary space usage.</p>
  <p class="section-note">Interpretation: High temp file churn usually means sorts/hashes spilling to disk; consider
    raising work_mem for the troublesome queries (not globally), improving indexes/filters, or reducing row width.
    If shared_buffers is small vs working set, cache hit ratios may drop; if it's very large, ensure checkpoint/IO
    settings are tuned to avoid long stalls.</p>

  <h2>Cache hit ratio by database</h2>
  <p class="muted">Interpretation: closer to 100% is better. Values above ~99% are typical for OLTP workloads. Lower
    ratios indicate more disk reads; consider increasing shared_buffers, reviewing working set size, and improving
    indexing and query plans.</p>
  <div id="table-cache-hit" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          <th>Database</th>
          <th>blks_hit</th>
          <th>blks_read</th>
          <th>Hit ratio</th>
        </tr>
      </thead>
      <tbody>
        {{if .Res.CacheHits}}
        {{range .Res.CacheHits}}{{if gt (add .BlksHit .BlksRead) 0}}<tr>
          <td>{{.Datname}}</td>
          <td>{{fmtI64 .BlksHit}}</td>
          <td>{{fmtI64 .BlksRead}}</td>
          <td>{{fmtF2 .Ratio}}%</td>
        </tr>{{end}}{{end}}
        {{else}}
        <tr>
          <td colspan="4" class="muted">No data</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  {{if gt (len .Res.CacheHits) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-cache-hit">Show all</button></div>{{end}}
  </div>
  {{if .CacheHitsSummary}}<p class="section-note">{{.CacheHitsSummary}}</p>{{end}}

  {{if .Res.WAL}}
  <h2>WAL statistics</h2>
  <div id="table-wal" class="table-wrap">
    <table>
      <thead>
        <tr><th>Metric</th><th>Value</th></tr>
      </thead>
      <tbody>
        <tr><td>WAL records</td><td>{{fmtI64 .Res.WAL.Records}}</td></tr>
        <tr><td>Full-page images</td><td>{{fmtI64 .Res.WAL.FullPage}}</td></tr>
        <tr><td>WAL bytes</td><td>{{fmtBytes .Res.WAL.Bytes}}</td></tr>
        <tr><td>Stats reset</td><td>{{fmtTime .Res.WAL.StatsReset}}</td></tr>
      </tbody>
    </table>
  </div>
  {{end}}
  {{if .Res.WAL}}<p class="section-note">Interpretation: WAL metrics are since last stats reset. Many full-page images and
    high WAL bytes/hour suggest frequent checkpoints or heavy write activity. Consider tuning checkpoint_timeout,
    max_wal_size, autovacuum settings, and reducing unnecessary bulk updates. Fewer checkpoints often reduce FPI rate.</p>{{end}}

  {{if .Res.TempFileStats}}
  <h2>Temporary file usage</h2>
  <div id="table-temp-files" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          <th>Database</th>
          <th>PID</th>
          <th>Files</th>
          <th>Size</th>
        </tr>
      </thead>
      <tbody>
        {{range .Res.TempFileStats}}
        <tr>
          <td>{{.Datname}}</td>
          <td>{{.PID}}</td>
          <td>{{fmtI64 .Files}}</td>
          <td>{{fmtBytes .Bytes}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}
  {{if .Res.WaitEvents}}<p class="section-note">Interpretation: IO-related waits point to storage pressure; review cache hit,
    shared_buffers, effective_io_concurrency, and query/index design. Lock waits usually indicate long transactions or
    hot rows; use the Blocking and Long running sections to find blockers, shorten transactions, add missing indexes,
    or reduce contention.</p>{{end}}

  <!-- Concurrency & waits -->
  {{if .Res.WaitEvents}}
  <h2>Wait events (top)</h2>
  <div id="table-waits" class="table-wrap collapsed">
    <table>
      <thead>
        <tr><th>Type</th><th>Event</th><th>Count</th></tr>
      </thead>
      <tbody>
        {{range .Res.WaitEvents}}
        <tr><td>{{.Type}}</td><td>{{.Event}}</td><td>{{.Count}}</td></tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{if .WaitsSummary}}<p class="section-note">{{.WaitsSummary}}</p>{{end}}
  {{end}}

  {{if .Res.LockStats}}
  <h2>Lock contention</h2>
  <div id="table-locks" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          <th>Lock Type</th>
          <th>Mode</th>
          <th>Granted</th>
          <th>Count</th>
          <th>Waiting PIDs</th>
        </tr>
      </thead>
      <tbody>
        {{range .Res.LockStats}}
        <tr>
          <td>{{.LockType}}</td>
          <td>{{.Mode}}</td>
          <td>{{if .Granted}}Yes{{else}}No{{end}}</td>
          <td>{{.Count}}</td>
          <td>{{range .WaitingPIDs}}{{.}} {{end}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}

  <h2>Blocking queries</h2>
  <div id="table-blocking" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          <th>DB</th>
          <th>Blocked PID</th>
          <th>Blocked for</th>
          <th>Blocking PID</th>
          <th>Blocking for</th>
          <th>Blocked query</th>
          <th>Blocking query</th>
        </tr>
      </thead>
      <tbody>
        {{if .Res.Blocking}}
        {{range .Res.Blocking}}<tr>
          <td>{{.Datname}}</td>
          <td>{{.BlockedPID}}</td>
          <td>{{.BlockedDuration}}</td>
          <td>{{.BlockingPID}}</td>
          <td>{{.BlockingDuration}}</td>
          <td>
            <pre>{{.BlockedQuery}}</pre>
          </td>
          <td>
            <pre>{{.BlockingQuery}}</pre>
          </td>
        </tr>{{end}}
        {{else}}
        <tr>
          <td colspan="7" class="muted">No blocking detected</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  {{if gt (len .Res.Blocking) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-blocking">Show all</button></div>{{end}}
  </div>
  <p class="section-note">{{.BlockingSummary}}</p>

  <h2>Long running queries (> 5m)</h2>
  <div id="table-long-running" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          <th>DB</th>
          <th>PID</th>
          <th>Duration</th>
          <th>State</th>
          <th>Query</th>
        </tr>
      </thead>
      <tbody>
        {{if .Res.LongRunning}}
        {{range .Res.LongRunning}}<tr>
          <td>{{.Datname}}</td>
          <td>{{.PID}}</td>
          <td>{{.Duration}}</td>
          <td>{{.State}}</td>
          <td>
            <pre>{{.Query}}</pre>
          </td>
        </tr>{{end}}
        {{else}}
        <tr>
          <td colspan="5" class="muted">No long running queries</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  {{if gt (len .Res.LongRunning) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-long-running">Show all</button></div>{{end}}
  </div>
  <p class="section-note">{{.LongRunningSummary}}</p>

  <h2>Autovacuum activities</h2>
  <div id="table-autovacuum" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          <th>DB</th>
          <th>PID</th>
          <th>Relation</th>
          <th>Phase</th>
          <th>Scanned</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {{if .Res.AutoVacuum}}
        {{range .Res.AutoVacuum}}<tr>
          <td>{{.Datname}}</td>
          <td>{{.PID}}</td>
          <td>{{.Relation}}</td>
          <td>{{.Phase}}</td>
          <td>{{fmtI64 .Scanned}}</td>
          <td>{{fmtI64 .Total}}</td>
        </tr>{{end}}
        {{else}}
        <tr>
          <td colspan="6" class="muted">No autovacuum workers</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  {{if gt (len .Res.AutoVacuum) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-autovacuum">Show all</button></div>{{end}}
  </div>
  <p class="section-note">{{.AutovacSummary}}</p>

  <!-- Storage & indexing -->
  <h2>Top tables by rows</h2>
  <div id="table-tables-by-rows" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          {{if .ShowDBTablesByRows}}<th>Database</th>{{end}}
          <th>Schema</th>
          <th>Table</th>
          <th>Rows</th>
        </tr>
      </thead>
      <tbody>
        {{if .TablesByRows}}
        {{range $i, $t := .TablesByRows}}{{if lt $i 100}}<tr>
          {{if $.ShowDBTablesByRows}}<td>{{$t.Database}}</td>{{end}}
          <td>{{$t.Schema}}</td>
          <td>{{$t.Name}}</td>
          <td>{{fmtI64 $t.NLiveTup}}</td>
        </tr>{{end}}{{end}}
        {{else}}
        <tr>
          {{if .ShowDBTablesByRows}}<td colspan="4" class="muted">No data</td>{{else}}<td colspan="3" class="muted">No data</td>{{end}}
        </tr>
        {{end}}
      </tbody>
    </table>
  {{if gt (len .TablesByRows) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-tables-by-rows">Show all</button></div>{{end}}
  </div>
  {{/* No explicit summary for this table to avoid noise */}}

  <h2>Top tables by size</h2>
  <div id="table-tables-by-size" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          {{if .ShowDBTablesBySize}}<th>Database</th>{{end}}
          <th>Schema</th>
          <th>Table</th>
          <th>Size</th>
        </tr>
      </thead>
      <tbody>
        {{if .TablesBySize}}
        {{range $i, $t := .TablesBySize}}{{if lt $i 100}}<tr>
          {{if $.ShowDBTablesBySize}}<td>{{$t.Database}}</td>{{end}}
          <td>{{$t.Schema}}</td>
          <td>{{$t.Name}}</td>
          <td>{{fmtBytes $t.SizeBytes}}</td>
        </tr>{{end}}{{end}}
        {{else}}
        <tr>
          {{if .ShowDBTablesBySize}}<td colspan="4" class="muted">No data</td>{{else}}<td colspan="3" class="muted">No data</td>{{end}}
        </tr>
        {{end}}
      </tbody>
    </table>
  {{if gt (len .TablesBySize) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-tables-by-size">Show all</button></div>{{end}}
  </div>
  {{/* No explicit summary for this table to avoid noise */}}

  <h2>Tables with lowest index usage</h2>
  <div id="table-index-usage-low" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          {{if .ShowDBIndexUsageLow}}<th>Database</th>{{end}}
          <th>Schema</th>
          <th>Table</th>
          <th>Index usage</th>
          <th>Rows</th>
        </tr>
      </thead>
      <tbody>
        {{if .Res.IndexUsageLow}}
        {{range .Res.IndexUsageLow}}<tr>
          {{if $.ShowDBIndexUsageLow}}<td>{{.Database}}</td>{{end}}
          <td>{{.Schema}}</td>
          <td>{{.Table}}</td>
          <td>{{fmtF2 .IndexUsagePct}}%</td>
          <td>{{fmtI64 .Rows}}</td>
        </tr>{{end}}
        {{else}}
        <tr>
          {{if .ShowDBIndexUsageLow}}<td colspan="5" class="muted">No data</td>{{else}}<td colspan="4" class="muted">No data</td>{{end}}
        </tr>
        {{end}}
      </tbody>
    </table>
  {{if gt (len .Res.IndexUsageLow) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-index-usage-low">Show all</button></div>{{end}}
  </div>
  {{if .IndexUsageSummary}}<p class="section-note">{{.IndexUsageSummary}}</p>{{end}}

  {{if .Res.IndexUnused}}
  <h2>Unused indexes</h2>
  <div id="table-index-unused" class="table-wrap{{if gt (len .Res.IndexUnused) 10}} collapsed{{end}}">
    <table>
      <thead>
        <tr>
          {{if .ShowDBIndexUnused}}<th>Database</th>{{end}}
          <th>Schema</th>
          <th>Table</th>
          <th>Index</th>
          <th>Size</th>
        </tr>
      </thead>
      <tbody>
        {{range .Res.IndexUnused}}<tr>
          {{if $.ShowDBIndexUnused}}<td>{{.Database}}</td>{{end}}
          <td>{{.Schema}}</td>
          <td>{{.Table}}</td>
          <td>{{.Name}}</td>
          <td>{{fmtBytes .SizeBytes}} {{if gt .SizeBytes 104857600}}<span class="badge-attn">Large</span>{{end}}</td>
        </tr>{{end}}
      </tbody>
    </table>
  {{if gt (len .Res.IndexUnused) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-index-unused">Show all</button></div>{{end}}
  </div>
  {{end}}
  <p class="section-note">{{.IndexUnusedSummary}}</p>

  <h2>Tables dead rows bloat</h2>
  <div id="table-index-counts" class="table-wrap{{if gt (len .Res.TablesWithIndexCount) 10}} collapsed{{end}}">
    <table>
      <thead>
        <tr>
          {{if .ShowDBIndexCounts}}<th>Database</th>{{end}}
          <th>Schema</th>
          <th>Table</th>
          <th>Index Count</th>
          <th>Size</th>
          <th>Rows</th>
          <th>Dead rows</th>
          <th>Bloat</th>
        </tr>
      </thead>
      <tbody>
        {{if .Res.TablesWithIndexCount}}
        {{range .Res.TablesWithIndexCount}}
        <tr{{if gt .BloatPct 20.0}} class="hot"{{end}}>
          {{if $.ShowDBIndexCounts}}<td>{{.Database}}</td>{{end}}
          <td>{{.Schema}}</td>
          <td>{{.Name}}</td>
          <td>{{.IndexCount}}</td>
          <td>{{fmtBytes .SizeBytes}}</td>
          <td>{{fmtThousands .RowCount}}</td>
          <td>{{fmtThousands .DeadRows}}</td>
          <td>{{fmtBytes (bloatBytes .SizeBytes .BloatPct)}} ({{printf "%.1f" .BloatPct}}%)</td>
          </tr>
          {{end}}
          {{else}}
          <tr>
            {{if .ShowDBIndexCounts}}<td colspan="8" class="muted">No data</td>{{else}}<td colspan="7" class="muted">No data</td>{{end}}
          </tr>
          {{end}}
      </tbody>
    </table>
  {{if gt (len .Res.TablesWithIndexCount) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-index-counts">Show all</button></div>{{end}}
  </div>
  {{if .BloatPctNote}}<p class="section-note">{{.BloatPctNote}}</p>{{end}}

  {{if .ReclaimByDB}}
  <h3>Reclaimable space by database (estimate)</h3>
  <div id="table-reclaim-by-db" class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Database</th>
          <th>Reclaimable (est.)</th>
        </tr>
      </thead>
      <tbody>
        {{range .ReclaimByDB}}
        <tr>
          <td>{{.Database}}</td>
          <td>{{fmtBytes .Bytes}}</td>
        </tr>
        {{end}}
      </tbody>
      <tfoot>
        <tr>
          <th>Total</th>
          <th>{{fmtBytes .ReclaimTotal}}</th>
        </tr>
      </tfoot>
    </table>
  </div>
  {{end}}

  {{if .Res.ProgressCreateIndex}}
  <h2>Index creation progress</h2>
  <div id="table-progress-ci" class="table-wrap">
    <table>
      <thead>
        <tr><th>DB</th><th>Relation</th><th>Phase</th><th>Blocks</th><th>Tuples</th><th>Lockers</th></tr>
      </thead>
      <tbody>
        {{range .Res.ProgressCreateIndex}}
        <tr>
          <td>{{.Datname}}</td>
          <td>{{.Relation}}</td>
          <td>{{.Phase}}</td>
          <td>{{fmtI64 .BlocksDone}} / {{fmtI64 .BlocksTotal}}</td>
          <td>{{fmtI64 .TuplesDone}} / {{fmtI64 .TuplesTotal}}</td>
          <td>{{fmtI64 .LockersDone}} / {{fmtI64 .LockersTotal}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}

  {{if .Res.ProgressAnalyze}}
  <h2>Analyze progress</h2>
  <div id="table-progress-analyze" class="table-wrap">
    <table>
      <thead>
        <tr><th>DB</th><th>Relation</th><th>Phase</th><th>Sample blocks</th></tr>
      </thead>
      <tbody>
        {{range .Res.ProgressAnalyze}}
        <tr>
          <td>{{.Datname}}</td>
          <td>{{.Relation}}</td>
          <td>{{.Phase}}</td>
          <td>{{fmtI64 .SampleScans}} / {{fmtI64 .SampleTotal}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}

  <!-- Query performance -->
  {{if .Res.Extensions.PgStatStatements}}
  {{if .Res.Statements.SkippedReason}}
  <h2>Top queries</h2>
  <p class="section-note">{{.Res.Statements.SkippedReason}}</p>
  {{else}}
  <h2>Top queries by total time</h2>
  {{if .Res.Statements.StatsDuration}}<p class="section-note">Data from pg_stat_statements, covering the last {{fmtDur .Res.Statements.StatsDuration}} (since {{fmtTime .Res.Statements.StatsResetTime}}).</p>{{end}}
  <div id="table-queries-total-time" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          <th>Calls</th>
          <th>Calls/hr</th>
          <th>Total time</th>
          <th>Mean time</th>
          <th>Attention</th>
          <th>Query</th>
        </tr>
      </thead>
      <tbody>
        {{if .Res.Statements.TopByTotalTime}}
        {{range $i, $q := .Res.Statements.TopByTotalTime}}
        <tr class="{{if lt $i 3}}hot{{end}}">
          <td class="nowrap">{{fmtF0 $q.Calls}}</td>
          <td class="nowrap">{{fmtF1 $q.CallsPerHour}}</td>
          <td class="nowrap">{{fmtMs $q.TotalTime}}</td>
          <td class="nowrap">{{fmtMs $q.MeanTime}}</td>
          <td>{{if $q.NeedsAttention}}<span class="badge-attn">Needs attention</span>{{else}}<span class="muted">-</span>{{end}}</td>
          <td>
            <pre id="query-pre-total-{{$i}}" class="query"><span class="query-short">{{printf "%.200s" $q.Query}}{{if gt (len $q.Query) 200}}...{{end}}</span><span class="query-full">{{$q.Query}}</span></pre>
            {{if gt (len $q.Query) 200}}<button type="button" class="show-full" onclick="pg_toggleFull(this)" data-target="#query-pre-total-{{$i}}">Show full</button>{{end}}
            {{if $q.Advice}}
            <div class="plan-advice">
              {{if $q.Advice.Highlights}}
              <h4>Plan highlights</h4>
              <ul>
                {{range $q.Advice.Highlights}}<li>{{.}}</li>{{end}}
              </ul>
              {{end}}
              {{if $q.Advice.Suggestions}}
              <h4>Suggestions</h4>
              <ul>
                {{range $q.Advice.Suggestions}}<li>{{.}}</li>{{end}}
              </ul>
              {{end}}
              {{if $q.Advice.Plan}}
              <pre id="plan-pre-total-{{$i}}" class="plan-pre" style="display:none">{{$q.Advice.Plan}}</pre>
              <button type="button" class="show-plan" onclick="pg_togglePlan(this)" data-target="#plan-pre-total-{{$i}}">Show plan</button>
              {{end}}
            </div>
            {{end}}
          </td>
        </tr>
        {{end}}
        {{else}}
        <tr>
          <td colspan="6" class="muted">No data</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  {{if gt (len .Res.Statements.TopByTotalTime) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-queries-total-time">Show all</button></div>{{end}}
  </div>

  <h2>Top queries by calls</h2>
  {{if .Res.Statements.StatsDuration}}<p class="section-note">Data from pg_stat_statements, covering the last {{fmtDur .Res.Statements.StatsDuration}} (since {{fmtTime .Res.Statements.StatsResetTime}}).</p>{{end}}
  <div id="table-queries-calls" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          <th>Calls</th>
          <th>Calls/hr</th>
          <th>Total time</th>
          <th>Mean time</th>
          <th>Attention</th>
          <th>Query</th>
        </tr>
      </thead>
      <tbody>
        {{if .Res.Statements.TopByCalls}}
        {{range $i, $q := .Res.Statements.TopByCalls}}
        <tr class="{{if lt $i 3}}hot{{end}}">
          <td class="nowrap">{{fmtF0 $q.Calls}}</td>
          <td class="nowrap">{{fmtF1 $q.CallsPerHour}}</td>
          <td class="nowrap">{{fmtMs $q.TotalTime}}</td>
          <td class="nowrap">{{fmtMs $q.MeanTime}}</td>
          <td>{{if $q.NeedsAttention}}<span class="badge-attn">Needs attention</span>{{else}}<span class="muted">-</span>{{end}}</td>
          <td>
            <pre id="query-pre-calls-{{$i}}" class="query"><span class="query-short">{{printf "%.200s" $q.Query}}{{if gt (len $q.Query) 200}}...{{end}}</span><span class="query-full">{{$q.Query}}</span></pre>
            {{if gt (len $q.Query) 200}}<button type="button" class="show-full" onclick="pg_toggleFull(this)" data-target="#query-pre-calls-{{$i}}">Show full</button>{{end}}
            {{if $q.Advice}}
            <div class="plan-advice">
              {{if $q.Advice.Highlights}}
              <h4>Plan highlights</h4>
              <ul>
                {{range $q.Advice.Highlights}}<li>{{.}}</li>{{end}}
              </ul>
              {{end}}
              {{if $q.Advice.Suggestions}}
              <h4>Suggestions</h4>
              <ul>
                {{range $q.Advice.Suggestions}}<li>{{.}}</li>{{end}}
              </ul>
              {{end}}
              {{if $q.Advice.Plan}}
              <pre id="plan-pre-calls-{{$i}}" class="plan-pre" style="display:none">{{$q.Advice.Plan}}</pre>
              <button type="button" class="show-plan" onclick="pg_togglePlan(this)" data-target="#plan-pre-calls-{{$i}}">Show plan</button>
              {{end}}
            </div>
            {{end}}
          </td>
        </tr>
        {{end}}
        {{else}}
        <tr>
          <td colspan="6" class="muted">No data</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  {{if gt (len .Res.Statements.TopByCalls) 10}}<div class="table-tools"><button type="button" class="toggle-rows" onclick="pg_toggleRows(this)" data-target="#table-queries-calls">Show all</button></div>{{end}}
  </div>
  {{end}}
  {{else}}
  <p>pg_stat_statements is not enabled in this database. Install and preload it for detailed query insights.</p>
  {{end}}

  {{if .Res.FunctionStats}}
  <h2>Top functions by total time</h2>
  <div id="table-functions" class="table-wrap collapsed">
    <table>
      <thead>
        <tr><th>Schema</th><th>Function</th><th>Calls</th><th>Total time</th><th>Self time</th></tr>
      </thead>
      <tbody>
        {{range .Res.FunctionStats}}
        <tr><td>{{.Schema}}</td><td>{{.Name}}</td><td>{{fmtI64 .Calls}}</td><td>{{fmtF2 .TotalTime}} ms</td><td>{{fmtF2 .SelfTime}} ms</td></tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}

  <!-- Replication -->
  {{if .Res.ReplicationStats}}
  <h2>Replication status</h2>
  <div id="table-replication" class="table-wrap collapsed">
    <table>
      <thead>
        <tr>
          <th>Replica</th>
          <th>State</th>
          <th>Sync State</th>
          <th>Priority</th>
          <th>Write Lag</th>
          <th>Flush Lag</th>
          <th>Replay Lag</th>
        </tr>
      </thead>
      <tbody>
        {{range .Res.ReplicationStats}}
        <tr>
          <td>{{.Name}}</td>
          <td>{{.State}}</td>
          <td>{{.SyncState}}</td>
          <td>{{.SyncPriority}}</td>
          <td>{{.WriteLag}}</td>
          <td>{{.FlushLag}}</td>
          <td>{{.ReplayLag}}</td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
  {{end}}

  <footer style="margin-top:24px;color:#6b7280;display:flex;align-items:center;gap:8px">Report generated at {{fmtTime
    .Meta.StartedAt}} in {{fmtDur .Meta.Duration}}</footer>

  <script>
    function pg_toggleRows(btn) {
      var sel = btn && btn.getAttribute('data-target');
      if (!sel) return false;
      var el = document.querySelector(sel);
      if (!el) return false;
      var willCollapse = !el.classList.contains('collapsed');
      if (el.classList.contains('collapsed')) {
        el.classList.remove('collapsed');
        btn.textContent = 'Show less';
      } else {
        el.classList.add('collapsed');
        btn.textContent = 'Show all';
      }
      // If we just collapsed, scroll back to the top of the table container
      if (willCollapse) {
        // Prefer native scrollIntoView if available
        if (typeof el.scrollIntoView === 'function') {
          el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
          var top = (el.getBoundingClientRect ? el.getBoundingClientRect().top : 0) + (window.pageYOffset || document.documentElement.scrollTop || 0);
          try { window.scrollTo({ top: top, behavior: 'smooth' }); } catch (e) { window.scrollTo(0, top); }
        }
      }
      return false;
    }

    function pg_toggleFull(btn) {
      var sel = btn && btn.getAttribute('data-target');
      if (!sel) return false;
      var el = document.querySelector(sel);
      if (!el) return false;
      if (el.classList.contains('expanded')) {
        el.classList.remove('expanded');
        btn.textContent = 'Show full';
      } else {
        el.classList.add('expanded');
        btn.textContent = 'Show less';
      }
      return false;
    }

    function pg_togglePlan(btn) {
      var sel = btn && btn.getAttribute('data-target');
      if (!sel) return false;
      var el = document.querySelector(sel);
      if (!el) return false;
      var isHidden = (el.style.display === '' || el.style.display === 'none');
      el.style.display = isHidden ? 'block' : 'none';
      btn.textContent = isHidden ? 'Hide plan' : 'Show plan';
      return false;
    }
  </script>
</body>

</html>